<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة المواقع</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI;background:#fafafa}
    header{padding:12px 16px;background:#fff;border-bottom:1px solid #eee}
    #map{height:55vh}
    .wrap{padding:12px 16px}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:8px 10px;border-bottom:1px solid #eee;text-align:right;font-size:14px}
    th{background:#f5f5f5}
    .muted{color:#6b7280}
  </style>
</head>
<body>
  <header>
    <h2>لوحة المواقع (آخر 200)</h2>
    <p class="muted">يتم التحميل من Supabase مباشرة.</p>
  </header>

  <div id="map"></div>
  <div class="wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th>الوقت</th><th>الملاحظة</th><th>الموقع</th><th>الدقة (م)</th>
          <th>IP</th><th>بطارية</th><th>سرعة</th><th>اتجاه</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // قيم مشروعك
    const PROJECT_URL = 'https://weaiftikalbujuecfuhf.supabase.co';
    const ANON_KEY    = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYWlmdGlrYWxidWp1ZWNmdWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTU2MzAsImV4cCI6MjA3MTk3MTYzMH0.kxiytsgnkEOim_zUD49zgVp7rxr3nHAVHFb0Jq9dijk';
    const supabase = window.supabase.createClient(PROJECT_URL, ANON_KEY);

    // الخريطة
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19,
      attribution: '&copy; OpenStreetMap'}).addTo(map);

    function fmtTime(iso){
      try { return new Date(iso).toLocaleString(); } catch { return iso; }
    }
    function gmapsLink(lat,lng){ return `https://maps.google.com/?q=${lat},${lng}`; }
    function fmt(v,dec=6){ return (v===null||v===undefined)?'':Number(v).toFixed(dec); }

    async function load(){
      const { data, error } = await supabase
        .from('pings')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(200);
      if (error) { alert(error.message); return; }

      const markers = [];
      const rows = data.map(r => {
        if (r.lat && r.lng){
          const m = L.marker([r.lat, r.lng]).addTo(map)
            .bindPopup(`${r.note ?? ''}<br>${fmtTime(r.created_at)}<br>${fmt(r.lat)}, ${fmt(r.lng)}`);
          markers.push(m);
        }
        const batt = (r.battery_level!=null ? Math.round(r.battery_level*100)+'%' : '') +
                     (r.battery_charging!=null ? (r.battery_charging?' ⚡':'') : '');
        const spd = (r.speed!=null ? (r.speed+' m/s') : '');
        const hdg = (r.heading!=null ? (Math.round(r.heading)+'°') : '');
        return `<tr>
          <td>${fmtTime(r.created_at)}</td>
          <td>${r.note ?? ''}</td>
          <td><a href="${gmapsLink(r.lat,r.lng)}" target="_blank">${fmt(r.lat)}, ${fmt(r.lng)}</a></td>
          <td>${r.accuracy ?? ''}</td>
          <td>${r.ip ?? ''}</td>
          <td>${batt}</td>
          <td>${spd}</td>
          <td>${hdg}</td>
        </tr>`;
      });

      document.querySelector('#tbl tbody').innerHTML = rows.join('');

      if (markers.length){
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
      } else {
        map.setView([23.8859, 45.0792], 5); // السعودية افتراضيًا
      }
    }
    load();
  </script>
</body>
</html>
