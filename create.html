<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>إنشاء إعداد Capture</title>
  <style>
    body{font-family:system-ui;-apple-system,Segoe UI;background:#fafafa;margin:0}
    .wrap{max-width:860px;margin:24px auto;background:#fff;border:1px solid #eee;border-radius:12px;padding:18px}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:#6b7280}
    button{padding:12px 16px;border:0;border-radius:10px;cursor:pointer}
    .primary{background:#111827;color:#fff}
    .out{background:#f3f4f6}
    .link{margin-top:12px;padding:10px;background:#f9fafb;border:1px dashed #ddd;border-radius:8px;direction:ltr}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>إنشاء/تعديل إعدادات صفحة التقاط الموقع</h2>
    <p class="muted">سيتم توليد رابط <b>capture.html?cfg=ID</b> بناءً على هذه الإعدادات.</p>

    <div class="row">
      <div>
        <label>العنوان (داخل الصفحة)</label>
        <input id="title" placeholder="تحديد موقعك…">
      </div>
      <div>
        <label>الوصف (داخل الصفحة)</label>
        <input id="description" placeholder="سنحاول GPS وإن رُفض نستخدم IP.">
      </div>
    </div>

    <label>رابط صورة المعاينة (OG image)</label>
    <input id="og_image_url" placeholder="https://.../preview.jpg">

    <div class="row">
      <div>
        <label>مسار التحويل بعد الحفظ (اختياري)</label>
        <input id="redirect_path" placeholder="/thanks.html">
      </div>
      <div>
        <label>ملاحظة ثابتة تُحفظ مع السجل (اختياري)</label>
        <input id="fixed_note" placeholder="عميل-واتساب-حملة-أكتوبر">
      </div>
    </div>

    <div class="row">
      <div>
        <label><input type="checkbox" id="require_gps"> يتطلب GPS فقط (بدون IP)</label>
      </div>
      <div>
        <label><input type="checkbox" id="allow_ip_fallback" checked> السماح بالرجوع إلى IP</label>
      </div>
    </div>

    <div class="row">
      <button class="primary" id="saveBtn">حفظ إعداد جديد</button>
      <button class="out" id="updateBtn">تحديث إعداد موجود (أدخل ID أدناه)</button>
    </div>

    <label class="muted">ID للتعديل (اختياري):</label>
    <input id="cfgId" placeholder="uuid">

    <div id="result" class="link" style="display:none"></div>

    <p class="muted">تلميح: افتح الرابط الناتج وشاركه. يمكن تعديل الإعدادات لاحقًا بنفس ID.</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const PROJECT_URL = 'https://weaiftikalbujuecfuhf.supabase.co';
    const ANON_KEY    = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYWlmdGlrYWxidWp1ZWNmdWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTU2MzAsImV4cCI6MjA3MTk3MTYzMH0.kxiytsgnkEOim_zUD49zgVp7rxr3nHAVHFb0Jq9dijk';
    const supabase = window.supabase.createClient(PROJECT_URL, ANON_KEY);

    const el = id => document.getElementById(id);

    function gather(){
      return {
        title: el('title').value || null,
        description: el('description').value || null,
        og_image_url: el('og_image_url').value || null,
        redirect_path: el('redirect_path').value || null,
        fixed_note: el('fixed_note').value || null,
        require_gps: el('require_gps').checked,
        allow_ip_fallback: el('allow_ip_fallback').checked
      };
    }

    async function saveNew(){
      const body = gather();
      const { data, error } = await supabase.from('configs').insert([body]).select('id').single();
      if (error) return alert('خطأ: '+error.message);
      const link = `https://xb7rbx.github.io/X/capture.html?cfg=${data.id}`;
      el('result').style.display='block';
      el('result').textContent = link;
    }

    async function updateExisting(){
      const id = el('cfgId').value.trim();
      if (!id) return alert('أدخل ID للتعديل');
      const body = gather();
      const { error } = await supabase.from('configs').update(body).eq('id', id);
      if (error) return alert('خطأ: '+error.message);
      const link = `https://xb7rbx.github.io/X/capture.html?cfg=${id}`;
      el('result').style.display='block';
      el('result').textContent = link + ' (تم التحديث)';
    }

    el('saveBtn').addEventListener('click', saveNew);
    el('updateBtn').addEventListener('click', updateExisting);
  </script>
</body>
</html>
