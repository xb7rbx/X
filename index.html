<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ØªØ´Ø®ÙŠØµ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</title>
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self' https://cdn.jsdelivr.net;
               connect-src 'self' https://*.supabase.co https://api.ipify.org;
               style-src 'self' 'unsafe-inline'">
<style>
  body{font-family:system-ui;margin:0;padding:16px;line-height:1.7;background:#fff}
  .ok{color:#047857;font-weight:700}.err{color:#b91c1c;font-weight:700}.muted{color:#6b7280}
  button{padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#f8fafc;cursor:pointer}
</style>
</head>
<body>
  <h3>ğŸ“ ØªØ´Ø®ÙŠØµ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (GPS ÙÙ‚Ø·)</h3>
  <p id="s" class="muted">Ø¨Ø¯Ø¡â€¦</p>
  <button id="retry" style="display:none">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  const SUPA_URL='https://weaiftikalbujuecfuhf.supabase.co';
  const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYWlmdGlrYWxidWp1ZWNmdWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTU2MzAsImV4cCI6MjA3MTk3MTYzMH0.kxiytsgnkEOim_zUD49zgVp7rxr3nHAVHFb0Jq9dijk';
  const supabase=window.supabase.createClient(SUPA_URL,SUPA_KEY);
  const s=(t,c='muted')=>{ const el=document.getElementById('s'); el.textContent=t; el.className=c; console.log(t); };

  function gps(timeout=25000){
    return new Promise((res,rej)=>{
      if(!('geolocation' in navigator)) return rej(new Error('Geolocation unsupported'));
      navigator.geolocation.getCurrentPosition(
        p=>res(p.coords),
        e=>rej(e),
        {enableHighAccuracy:true,timeout,maximumAge:0}
      );
    });
  }
  async function ip(){
    try{const r=await fetch('https://api.ipify.org?format=json',{cache:'no-store'}); const j=await r.json(); return j.ip||null;}
    catch{return null;}
  }
  async function run(){
    document.getElementById('retry').style.display='none';
    try{
      s('Ø·Ù„Ø¨ Ø¥Ø°Ù† GPS Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­â€¦');
      const c=await gps(25000);
      s('Ø¬Ù„Ø¨ Ø¹Ù†ÙˆØ§Ù† IPâ€¦');
      const ipStr=await ip();
      s('Ø­ÙØ¸ ÙÙŠ Supabaseâ€¦');
      const {data,error,status}=await supabase.from('locations').insert([{
        device_name:navigator.userAgent,
        ip:ipStr,
        lat:c.latitude,lng:c.longitude,accuracy:c.accuracy??null
      }]).select('id');
      if(error){ s('Ø®Ø·Ø£ Supabase: '+error.message,'err'); document.getElementById('retry').style.display='inline-block'; return; }
      s('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ“ (id='+data[0].id+')','ok');
    }catch(e){
      let msg = e.message || ('code '+e.code);
      if(e.code===1) msg='Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù† (User denied Geolocation)';
      else if(e.code===2) msg='Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­ Ù…Ø¤Ù‚ØªÙ‹Ø§';
      else if(e.code===3) msg='Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø·Ù„Ø¨';
      s('ÙØ´Ù„: '+msg,'err');
      document.getElementById('retry').style.display='inline-block';
    }
  }
  document.getElementById('retry').onclick=run;

  // Ø¨Ø¹Ø¶ Ø£Ø¬Ù‡Ø²Ø© iOS Ù„Ø§ ØªØ¸Ù‡Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø°Ù† Ø¯ÙˆÙ† ØªÙØ§Ø¹Ù„:
  // Ø£ÙˆÙ„ Ù†Ù‚Ø±Ø© Ø³ØªØ¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
  window.addEventListener('click', ()=>{ if(document.getElementById('retry').style.display!=='none') run(); }, {passive:true});

  run();
  </script>
</body>
</html>
